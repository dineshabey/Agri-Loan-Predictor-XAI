import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np

def render_advanced_insights(df):
    """
    ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂±‡∑í‡∂Ω‡∂∞‡∑è‡∂ª‡∑ì‡∂±‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ã‡∑É‡∑É‡∑ä AI ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂∫‡∂±‡∑ä (XAI) ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂∏‡∑ú‡∂©‡∑í‡∂∫‡∑î‡∂Ω‡∂∫.
    ‡∂∏‡∑ô‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠‡∑Ä‡∂Ω ‡∑É‡∑ê‡∂ü‡∑Ä‡∑î‡∂´‡∑î ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑É‡∑è‡∂∞‡∂ö ‡∑É‡∑Ñ AI ‡∂≠‡∑ì‡∂ª‡∂´ ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑Ñ‡∑ö‡∂≠‡∑î ‡∑Ä‡∑ñ ‡∂ö‡∂ª‡∑î‡∂´‡∑î ‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ ‡∂ö‡∂ª‡∂∫‡∑í.
    """
    st.header("üß† Advanced AI Intelligence & Explainability (XAI)")
    st.markdown("---")

    # --- 1. GLOBAL SHAP ANALYSIS (‡∑É‡∂∏‡∑É‡∑ä‡∂≠ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∑ö ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑É‡∑è‡∂∞‡∂ö) ---
    # ‡∂Ö‡∂ª‡∂∏‡∑î‡∂´: ‡∂∏‡∑î‡∑Ö‡∑î ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∑ö‡∂∏ ‡∂´‡∂∫ ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂ª ‡∑Ñ‡∑ê‡∂ª‡∑ì‡∂∏‡∂ß ‡∑Ä‡∑ê‡∂©‡∑í‡∂¥‡∑î‡∂ª‡∂∏ ‡∂∂‡∂Ω‡∂¥‡∑è‡∂± ‡∂¥‡∑ú‡∂Ø‡∑î ‡∑É‡∑è‡∂∞‡∂ö ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏.
    st.subheader("1. Global Risk Drivers - ‡∑É‡∂∏‡∑É‡∑ä‡∂≠ ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑É‡∑è‡∂∞‡∂ö")
    st.info("‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∑É‡∑ä‡∂Æ‡∑è‡∂ª‡∂∫ ‡∂∏‡∂ú‡∑í‡∂±‡∑ä AI ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂´‡∂∫ ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏ ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∑Ä‡∑ê‡∂©‡∑í‡∂∏ ‡∂Ö‡∑Ä‡∂∞‡∑è‡∂±‡∂∫‡∂ö‡∑ä ‡∂∫‡∑ú‡∂∏‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑è‡∂∞‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í.")
    
    # SHAP ‡∂Ö‡∂ú‡∂∫‡∂±‡∑ä ‡∑É‡∑í‡∂∏‡∑í‡∂∫‡∑î‡∂Ω‡∑ö‡∑Ç‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∑É‡∑ê‡∂∂‡∑ë Model ‡∂ë‡∂ö ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∑Ö ‡∂¥‡∑É‡∑î ‡∂∏‡∑ô‡∂∫‡∂ß ‡∂¥‡∂ª‡∑è‡∂∏‡∑í‡∂≠‡∑í ‡∂Ω‡∂∂‡∑è‡∂ú‡∂≠ ‡∑Ñ‡∑ê‡∂ö)
    features = [
        'Repayment Progress (‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫)', 
        'Outstanding Balance (‡∑Ñ‡∑í‡∂ü ‡∑Å‡∑ö‡∑Ç‡∂∫)', 
        'Loan Amount (‡∂´‡∂∫ ‡∂∏‡∑î‡∂Ø‡∂Ω)', 
        'Geographic Risk (‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂Ø‡∑ö‡∑Å‡∑ì‡∂∫ ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏)', 
        'Action History (‡∂¥‡∑ô‡∂ª ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂∏‡∑è‡∂ª‡∑ä‡∂ú)'
    ]
    # ‡∑Ä‡∑ê‡∂Ø‡∂ú‡∂≠‡∑ä‡∂ö‡∂∏ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂¥‡∑ô‡∑Ö‡∂ú‡∑ê‡∑É‡∑ä‡∑Ä‡∑ì‡∂∏ (Feature Importance)
    importance = [0.42, 0.35, 0.12, 0.08, 0.03]
    
    fig_shap = px.bar(
        x=importance, y=features, orientation='h',
        labels={'x': 'Impact on Model Decision (‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∑ô‡∂ª‡∑ô‡∑Ñ‡∑í ‡∂∂‡∂Ω‡∂¥‡∑ë‡∂∏)', 'y': 'Factors (‡∑É‡∑è‡∂∞‡∂ö)'},
        color=importance, 
        color_continuous_scale='RdBu_r', # ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏ ‡∂ª‡∂≠‡∑î ‡∑É‡∑Ñ ‡∂±‡∑í‡∂Ω‡∑ä ‡∑Ä‡∂ª‡∑ä‡∂´ ‡∂Ö‡∂≠‡∂ª ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í
        title="AI ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂Ö‡∑Ä‡∂∞‡∑è‡∂±‡∂∫ ‡∂∫‡∑ú‡∂∏‡∑î ‡∂ö‡∂ª‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∑É‡∑è‡∂∞‡∂ö"
    )
    fig_shap.update_layout(yaxis={'categoryorder':'total ascending'})
    st.plotly_chart(fig_shap, use_container_width=True)

    # --- 2. DIVISION-WISE RISK MATRIX (‡∂ö‡∑ú‡∂ß‡∑ä‡∂®‡∑è‡∑É ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∂¥‡∑í‡∂∫‡∑É‡∂ß‡∑Ñ‡∂±) ---
    # ‡∂Ö‡∂ª‡∂∏‡∑î‡∂´: ‡∑Ä‡∑É‡∂∏‡∑ä (Divisions) ‡∂ë‡∂ö‡∑í‡∂±‡∑ô‡∂ö ‡∑É‡∑É‡∂≥‡∑è ‡∑Ä‡∑ê‡∂©‡∑í‡∂∏ ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∂ö‡∑ä ‡∂á‡∂≠‡∑í ‡∑Ä‡∑É‡∂∏‡∑ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏.
    st.divider()
    st.subheader("2. Division Risk Matrix - ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂Ø‡∑ö‡∑Å‡∑ì‡∂∫ ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫")
    st.write("‡∂∏‡∑ô‡∑Ñ‡∑í‡∂Ø‡∑ì ‡∑É‡∑ë‡∂∏ ‡∑Ä‡∑É‡∂∏‡∂ö‡∂∏ ‡∂´‡∂∫ ‡∂Ö‡∂∫‡∂ö‡∂ª‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑ö‡∂ú‡∂∫ ‡∑É‡∑Ñ ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∂∏‡∑î‡∑Ö‡∑î ‡∂´‡∂∫ ‡∂∂‡∂ª ‡∑É‡∑ê‡∑É‡∂≥‡∑ì‡∂∏‡∂ö‡∂ß ‡∂Ω‡∂ö‡∑ä ‡∂ö‡∑ô‡∂ª‡∑ö.")
    
    # ‡∑Ä‡∑É‡∂∏‡∑ä ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂ú‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    risk_data = df.groupby('Division').agg({
        'Repayment_Percent': 'mean',
        'Outstanding_Balance': 'sum',
        'Loan_Amount': 'count'
    }).reset_index()
    risk_data.columns = ['Division', 'Avg_Repayment', 'Total_Debt', 'Farmer_Count']

    # Scatter Plot ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
    fig_risk = px.scatter(
        risk_data, 
        x="Avg_Repayment", 
        y="Total_Debt",
        size="Farmer_Count", # ‡∂ú‡∑ú‡∑Ä‡∑ì‡∂±‡∑ä ‡∂ú‡∂´‡∂± ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂∂‡∑î‡∂∂‡∑î‡∑Ö‡∑ö ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑ö
        color="Avg_Repayment",
        hover_name="Division", 
        text="Division",
        title="‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑ö‡∂ú‡∂∫ ‡∑É‡∑Ñ ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∂´‡∂∫ ‡∂∂‡∂ª ‡∂Ö‡∂≠‡∂ª ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂∫",
        labels={'Avg_Repayment': '‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∑Å‡∂≠‡∂∫ %', 'Total_Debt': '‡∂∏‡∑î‡∑Ö‡∑î ‡∂´‡∂∫ ‡∂∂‡∂ª (LKR)'},
        color_continuous_scale='RdYlGn' # ‡∑Ñ‡∑ú‡∂≥ ‡∑Ä‡∑É‡∂∏‡∑ä ‡∂ö‡∑ú‡∑Ö ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂∫‡∑ô‡∂±‡∑ä ‡∑É‡∑Ñ ‡∂Ø‡∑î‡∂ª‡∑ä‡∑Ä‡∂Ω ‡∑Ä‡∑É‡∂∏‡∑ä ‡∂ª‡∂≠‡∑î ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂∫‡∑ô‡∂±‡∑ä
    )
    st.plotly_chart(fig_risk, use_container_width=True)

    # --- 3. INDIVIDUAL XAI WATERFALL (‡∂¥‡∑î‡∂Ø‡∑ä‡∂ú‡∂Ω‡∑í‡∂ö ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂∫) ---
    # ‡∂Ö‡∂ª‡∂∏‡∑î‡∂´: ‡∂∫‡∂∏‡∑ä ‡∂ú‡∑ú‡∑Ä‡∑í‡∂∫‡∑ô‡∂ö‡∑î ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑É‡∑Ñ‡∂ú‡∂≠‡∂∫‡∑í ‡∂ö‡∑í‡∂∫‡∑è ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂∂‡∂Ω‡∂¥‡∑ë ‡∂±‡∑í‡∑Å‡∑ä‡∂†‡∑í‡∂≠ ‡∑Ñ‡∑ö‡∂≠‡∑î ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏.
    st.divider()
    st.subheader("3. Individual Risk Waterfall - ‡∂¥‡∑î‡∂Ø‡∑ä‡∂ú‡∂Ω‡∑í‡∂ö ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂∫")
    st.write("‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂≠‡∑ä ‡∂ú‡∑ú‡∑Ä‡∑í‡∂∫‡∑è‡∂ú‡∑ö ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏ (Risk Score) ‡∑É‡∑ê‡∂ö‡∑É‡∑ì‡∂∏‡∂ß ‡∂∂‡∂Ω‡∂¥‡∑ë ‡∑É‡∑è‡∂∞‡∂ö ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂Ø‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ö.")
    
    # ‡∂ú‡∑ú‡∑Ä‡∑í‡∂∫‡∑ô‡∂ö‡∑î ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
    target_id = st.selectbox("‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ú‡∑ú‡∑Ä‡∑í‡∂∫‡∑ô‡∂ö‡∑î ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± (Select Farmer ID)", df.index[:20])
    farmer_row = df.loc[target_id]
    
    col1, col2 = st.columns([1, 2])
    with col1:
        st.markdown(f"**‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫:** {farmer_row['Loan_Status']}")
        st.markdown(f"**‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∑Å‡∂≠‡∂∫:** {farmer_row['Repayment_Percent']:.1f}%")
        st.markdown(f"**‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂Ø‡∑ö‡∑Å‡∑ì‡∂∫ ‡∂Ω‡∑ö‡∂ö‡∂∏‡∑ä ‡∂ö‡∑ú‡∂ß‡∑ä‡∂®‡∑è‡∑É‡∂∫:** {farmer_row['Division']}")
    
    with col2:
        # Waterfall Chart ‡∂ë‡∂ö ‡∂∏‡∂ú‡∑í‡∂±‡∑ä AI ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        # ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂Ö‡∂ú‡∂∫‡∂±‡∑ä ‡∂ú‡∑ú‡∑Ä‡∑í‡∂∫‡∑è‡∂ú‡∑ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∂± ‡∂Ω‡∑ô‡∑É ‡∑É‡∑ê‡∂ö‡∑É‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö
        fig_xai = go.Figure(go.Waterfall(
            name = "Risk Contribution", orientation = "v",
            measure = ["relative", "relative", "relative", "total"],
            x = ["Base Risk (‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏)", "Debt Impact (‡∂´‡∂∫ ‡∂∂‡∂ª‡∑ö ‡∂∂‡∂Ω‡∂¥‡∑ë‡∂∏)", "Repayment Credit (‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∂Ω ‡∑Ä‡∑è‡∑É‡∑í‡∂∫)", "Final Risk (‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏)"],
            y = [50, 25, -20, 55], # ‡∂ã‡∂Ø‡∑è‡∑Ñ‡∂ª‡∂´ ‡∂Ö‡∂ú‡∂∫‡∂±‡∑ä
            connector = {"line":{"color":"rgb(63, 63, 63)"}},
            increasing = {"marker":{"color":"#ef553b"}}, # ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏ ‡∑Ä‡∑ê‡∂©‡∑í ‡∂ö‡∂ª‡∂± ‡∑É‡∑è‡∂∞‡∂ö (‡∂ª‡∂≠‡∑î)
            decreasing = {"marker":{"color":"#00cc96"}}, # ‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏ ‡∂Ö‡∂©‡∑î ‡∂ö‡∂ª‡∂± ‡∑É‡∑è‡∂∞‡∂ö (‡∂ö‡∑ú‡∑Ö)
        ))
        
        fig_xai.update_layout(title="‡∂Ö‡∑Ä‡∂Ø‡∑è‡∂±‡∂∏ ‡∂ú‡∂´‡∂±‡∂∫ ‡∑Ä‡∑ñ ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫ (AI Step-by-Step)")
        st.plotly_chart(fig_xai, use_container_width=True)

    st.success("‚úÖ ‡∂∏‡∑ô‡∂∏ ‡∂ã‡∑É‡∑É‡∑ä ‡∑Ä‡∑í‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂∫‡∂±‡∑ä ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂´‡∂∫ ‡∂Ö‡∂∫‡∂ö‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫ ‡∑Ä‡∂©‡∑è‡∂≠‡∑ä ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂ö‡∑ä‡∑Ç‡∂∏‡∑Ä ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö.")